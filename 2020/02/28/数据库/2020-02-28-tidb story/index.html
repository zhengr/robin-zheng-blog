<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>TiDB 几个关键点探究</title><meta name="description" content="观天之道，执天之行"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/highlight-theme-light.css"><script src="/jslib/highlight.pack.js"></script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Robin's blog" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-space-between is-hidden-mobile"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Robin's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">TiDB 几个关键点探究</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#TiDB-%E5%87%A0%E4%B8%AA%E5%85%B3%E9%94%AE%E7%82%B9%E6%8E%A2%E7%A9%B6"><span class="toc-text">TiDB 几个关键点探究</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TiDB%E5%87%A0%E4%B8%AA%E6%A0%B8%E5%BF%83%E7%9A%84%E7%82%B9"><span class="toc-text">TiDB几个核心的点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TiDB-Server"><span class="toc-text">TiDB Server</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PD-Server-%E5%80%9F%E5%8A%9Betcd-Raft"><span class="toc-text">PD Server(借力etcd Raft)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TiKV-Server-%E5%80%9F%E5%8A%9BRocksDB"><span class="toc-text">TiKV Server(借力RocksDB)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TiSpark-%E5%80%9F%E5%8A%9BSpark"><span class="toc-text">TiSpark (借力Spark)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TiDB-Operator"><span class="toc-text">TiDB Operator</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%85%B3%E9%94%AE%E7%82%B9%EF%BC%9ARocksDB"><span class="toc-text">第一个关键点：RocksDB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-text">功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LevelDB%E6%89%80%E6%B2%A1%E6%9C%89%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-text">LevelDB所没有的功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%85%B3%E9%94%AE%E7%82%B9%EF%BC%9ARaft"><span class="toc-text">第二个关键点：Raft</span></a></li></ol></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/Oracle"><i class="tag post-item-tag">Oracle</i></a><a href="/tags/TiDB"><i class="tag post-item-tag">TiDB</i></a><a href="/tags/RocksDB"><i class="tag post-item-tag">RocksDB</i></a><a href="/tags/Raft"><i class="tag post-item-tag">Raft</i></a><a href="/tags/PolarDB"><i class="tag post-item-tag">PolarDB</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">TiDB 几个关键点探究</h1><time class="has-text-grey" datetime="2020-02-28T00:00:00.000Z">2020-02-28</time><article class="mt-2 post-content"><h2 id="TiDB-几个关键点探究"><a href="#TiDB-几个关键点探究" class="headerlink" title="TiDB 几个关键点探究"></a>TiDB 几个关键点探究</h2><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>各路Newsql数据库做的越来越好， 在未来数字化道路上，数据库作为最基本的组成要素，该如何决策？ 是继续跑在IOE上，大把大把烧钞票来维系着高可用？ 还是用日渐成熟的互联网开源武器武装自己。这是个关于钱和事的大问题。</p>
<p>我提倡的策略是 <em>积极试用，谨慎展开。分级替换，评估成本。</em></p>
<p>当前M平台每日入库数据在500万-700万条，不久会增加到至少1000万条/日。 而且数据实时计算要求越来越高，怎么办？</p>
<p>2020-02-16 5,546,434 records<br>2020-02-15 6,498,376 records<br>2020-02-14 5,227,550 records</p>
<p>如果不花大把银子（部署Exadata）， 用普通Oracle，Mysql，postgreSQL架构是不容易搞定这个场景要求的。</p>
<p>当下各种NewSQL都开始商业化试用，特别是各类基于 MySQL 生态和兼容 MySQL 协议的新数据库产品，包括在 OLTP 上进一步优化的 POLARDB（2.0支持Oracle 规范）、Aurora、X-DB等等，还有兼容 OLTP 和 OLAP 场景的 HTAP 上优化的 HybridDB、TiDB、BaikalDB 等等。 重点可以关注POLARDB和TiDB（当前仅支持Mysql规范）。</p>
<h2 id="TiDB几个核心的点"><a href="#TiDB几个核心的点" class="headerlink" title="TiDB几个核心的点"></a>TiDB几个核心的点</h2><p><img src="https://i.loli.net/2020/02/28/Eq69rWMVX4atbRg.png"></p>
<blockquote>
<h4 id="TiDB-Server"><a href="#TiDB-Server" class="headerlink" title="TiDB Server"></a>TiDB Server</h4><p>TiDB Server 负责接收 SQL 请求，处理 SQL 相关的逻辑，并通过 PD 找到存储计算所需数据的 TiKV 地址，与 TiKV 交互获取数据，最终返回结果。TiDB Server 是无状态的，其本身并不存储数据，只负责计算，可以无限水平扩展，可以通过负载均衡组件（如LVS、HAProxy 或 F5）对外提供统一的接入地址。</p>
<h4 id="PD-Server-借力etcd-Raft"><a href="#PD-Server-借力etcd-Raft" class="headerlink" title="PD Server(借力etcd Raft)"></a>PD Server(借力etcd Raft)</h4><p>Placement Driver (简称 PD) 是整个集群的管理模块，其主要工作有三个：一是存储集群的元信息（某个 Key 存储在哪个 TiKV 节点）；二是对 TiKV 集群进行调度和负载均衡（如数据的迁移、Raft group leader 的迁移等）；三是分配全局唯一且递增的事务 ID。</p>
<p>PD 通过 Raft 协议保证数据的安全性。Raft 的 leader server 负责处理所有操作，其余的 PD server 仅用于保证高可用。建议部署奇数个 PD 节点。</p>
<h4 id="TiKV-Server-借力RocksDB"><a href="#TiKV-Server-借力RocksDB" class="headerlink" title="TiKV Server(借力RocksDB)"></a>TiKV Server(借力RocksDB)</h4><p>TiKV Server 负责存储数据，从外部看 TiKV 是一个分布式的提供事务的 Key-Value 存储引擎。存储数据的基本单位是 Region，每个 Region 负责存储一个 Key Range（从 StartKey 到 EndKey 的左闭右开区间）的数据，每个 TiKV 节点会负责多个 Region。TiKV 使用 Raft 协议做复制，保持数据的一致性和容灾。副本以 Region 为单位进行管理，不同节点上的多个 Region 构成一个 Raft Group，互为副本。数据在多个 TiKV 之间的负载均衡由 PD 调度，这里也是以 Region 为单位进行调度。</p>
<h4 id="TiSpark-借力Spark"><a href="#TiSpark-借力Spark" class="headerlink" title="TiSpark (借力Spark)"></a>TiSpark (借力Spark)</h4><p>TiSpark 作为 TiDB 中解决用户复杂 OLAP 需求的主要组件，将 Spark SQL 直接运行在 TiDB 存储层上，同时融合 TiKV 分布式集群的优势，并融入大数据社区生态。至此，TiDB 可以通过一套系统，同时支持 OLTP 与 OLAP，免除用户数据同步的烦恼。</p>
<h4 id="TiDB-Operator"><a href="#TiDB-Operator" class="headerlink" title="TiDB Operator"></a>TiDB Operator</h4><p>TiDB Operator 提供在主流云基础设施（Kubernetes）上部署管理 TiDB 集群的能力。它结合云原生社区的容器编排最佳实践与 TiDB 的专业运维知识，集成一键部署、多集群混部、自动运维、故障自愈等能力，极大地降低了用户使用和管理 TiDB 的门槛与成本。</p>
</blockquote>
<h3 id="第一个关键点：RocksDB"><a href="#第一个关键点：RocksDB" class="headerlink" title="第一个关键点：RocksDB"></a>第一个关键点：RocksDB</h3><p>TiDB的说法：</p>
<blockquote>
<p>任何持久化的存储引擎，数据终归要保存在磁盘上，TiKV 也不例外。但是 TiKV 没有选择直接向磁盘上写数据，而是把数据保存在 RocksDB 中，具体的数据落地由 RocksDB 负责。</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://rocksdb.org/">RocksDB 英文</a></li>
<li><a target="_blank" rel="noopener" href="https://rocksdb.org.cn/">RocksDB中文网</a></li>
</ul>
<p>Facebook 这个项目是比较有意思的，个人觉得比PolarDB里那个阿里搞的PolarFS有趣。</p>
<blockquote>
<p>RocksDB是使用C++编写的嵌入式kv存储引擎，其键值均允许使用二进制流。由Facebook基于levelDB开发， 提供向后兼容的levelDB API。</p>
<p>RocksDB针对Flash存储进行优化，延迟极小。RocksDB使用LSM存储引擎，纯C++编写。Java版本RocksJava正在开发中。参见<a target="_blank" rel="noopener" href="https://rocksdb.org.cn/doc/RocksJava-Basics.html">RocksJavaBasic</a>。</p>
<p>RocksDB依靠大量灵活的配置，使之能针对不同的生产环境进行调优，包括直接使用内存，使用Flash，使用硬盘或者HDFS。支持使用不同的压缩算法，并且有一套完整的工具供生产和调试使用。</p>
<h4 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h4><ul>
<li>为需要存储TB级别数据到本地FLASH或者RAM的应用服务器设计</li>
<li>针对存储在高速设备的中小键值进行优化——你可以存储在flash或者直接存储在内存</li>
<li>性能碎CPU数量线性提升，对多核系统友好</li>
</ul>
<h4 id="LevelDB所没有的功能"><a href="#LevelDB所没有的功能" class="headerlink" title="LevelDB所没有的功能"></a>LevelDB所没有的功能</h4><p>RocksDB增加了许多新功能，参考<a target="_blank" rel="noopener" href="https://rocksdb.org.cn/doc/Features-Not-in-LevelDB.html">features not in LevelDB</a></p>
</blockquote>
<p>没有这么简单，TiDB实际上有个项目在<a target="_blank" rel="noopener" href="https://tikv.org/">https://tikv.org/</a> 这才是TiKV正主，虽然是系出RocksDB。</p>
<p>TiKV is implemented in the <a target="_blank" rel="noopener" href="https://rust-lang.org/">Rust</a> programming language. It uses technologies like <a target="_blank" rel="noopener" href="https://rocksdb.org/">Facebook’s RocksDB</a> and <a target="_blank" rel="noopener" href="https://raft.github.io/">Raft</a>.</p>
<p>The project was originally inspired by <a target="_blank" rel="noopener" href="https://ai.google/research/pubs/pub39966">Google Spanner</a> and <a target="_blank" rel="noopener" href="https://hbase.apache.org/">HBase</a>.</p>
<p><img src="https://i.loli.net/2020/02/28/jQaCLme19MgySAk.png"></p>
<h3 id="第二个关键点：Raft"><a href="#第二个关键点：Raft" class="headerlink" title="第二个关键点：Raft"></a>第二个关键点：Raft</h3><p>TiDB的说法：</p>
<blockquote>
<p>一件更难的事情：如何保证单机失效的情况下，数据不丢失，不出错？简单来说，我们需要想办法把数据复制到多台机器上，这样一台机器挂了，我们还有其他的机器上的副本；复杂来说，我们还需要这个复制方案是可靠、高效并且能处理副本失效的情况。听上去比较难，但是好在我们有 Raft 协议。Raft 是一个一致性算法，它和 Paxos 等价，但是更加易于理解。<a target="_blank" rel="noopener" href="https://raft.github.io/raft.pdf">这里</a>是 Raft 的论文，感兴趣的可以看一下。本文只会对 Raft 做一个简要的介绍，细节问题可以参考论文。另外提一点，Raft 论文只是一个基本方案，严格按照论文实现，性能会很差，我们对 Raft 协议的实现做了大量的优化，具体的优化细节可参考我司首席架构师唐刘同学的<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25735592">这篇文章</a>。</p>
<p>Raft 是一个一致性协议，提供几个重要的功能：</p>
<ol>
<li>Leader 选举</li>
<li>成员变更</li>
<li>日志复制</li>
</ol>
<p>TiKV 利用 Raft 来做数据复制，每个数据变更都会落地为一条 Raft 日志，通过 Raft 的日志复制功能，将数据安全可靠地同步到 Group 的多数节点中。</p>
<p><img src="https://i.loli.net/2020/02/28/sygmRpGbv48DHe3.png"></p>
</blockquote>
<p>我们进一步看看：</p>
<p>本质上来说TiDB 采用的是etcd Raft，Distributed reliable key-value store for the most critical data of a distributed system <a target="_blank" rel="noopener" href="https://etcd.io/">https://etcd.io</a> 这个方案， 其中引入包情况如下：</p>
<pre><code class="go">&quot;go.etcd.io/etcd/clientv3&quot;
&quot;go.etcd.io/etcd/embed&quot;
&quot;go.etcd.io/etcd/pkg/types&quot;</code></pre>
<blockquote>
<p>参考一下阿里云的Polardb架构，他们用Parallel-Raft协议保证数据的一致性，这块闭源， 具体了解可以参考阿里在PVLDB的一篇论文《PolarFS: An Ultra-low Latency and Failure Resilient Distributed File System for Shared Storage Cloud Database》，其中介绍了一种比Raft更高效的一致性协议ParallelRaft，号称可以支持乱序提交。从ParallelRaft看得出阿里工程能力挺强。</p>
<p>Raft是一个比Paxos更易于理解与实现的一致性协议(consensus protocol)，详细介绍参考<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27207160">Raft协议详解</a>和分布式系统的<a target="_blank" rel="noopener" href="https://www.jdon.com/artichect/raft.html">Raft算法</a>。  来自<a target="_blank" rel="noopener" href="https://blog.csdn.net/hnwyllmm/article/details/97908463">参考文章</a>。</p>
</blockquote>
<p><img src="https://i.loli.net/2020/02/28/7cgtVhsGXaoNKP4.png"></p>
<p>再去看TiDB的Region Syncer，pd/server/region_syncer/server.go</p>
<pre><code class="go">// RegionSyncer is used to sync the region information without raft.
type RegionSyncer struct &#123;
    sync.RWMutex
    streams            map[string]ServerStream
    regionSyncerCtx    context.Context
    regionSyncerCancel context.CancelFunc
    server             Server
    closed             chan struct&#123;&#125;
    wg                 sync.WaitGroup
    history            *historyBuffer
    limit              *ratelimit.Bucket
    securityConfig     *grpcutil.SecurityConfig
&#125;

// NewRegionSyncer returns a region syncer.
// The final consistency is ensured by the heartbeat.
// Strong consistency is not guaranteed.
// Usually open the region syncer in huge cluster and the server
// no longer etcd but go-leveldb.
func NewRegionSyncer(s Server) *RegionSyncer &#123;
    return &amp;RegionSyncer&#123;
        streams:        make(map[string]ServerStream),
        server:         s,
        closed:         make(chan struct&#123;&#125;),
        history:        newHistoryBuffer(defaultHistoryBufferSize, s.GetStorage().GetRegionStorage()),
        limit:          ratelimit.NewBucketWithRate(defaultBucketRate, defaultBucketCapacity),
        securityConfig: s.GetSecurityConfig(),
    &#125;
&#125;</code></pre>
<p>所以可以看到Region的Sync是采用了go-leveldb而非etcd。这是为啥呢？ 其实吧，LeveldbKV is used to store regions information. // RegionSyncer is used to sync the region information without raft. </p>
<pre><code class="go">&quot;github.com/syndtr/goleveldb/leveldb&quot;
&quot;github.com/syndtr/goleveldb/leveldb/util&quot;</code></pre>
<p>具体参见 <a target="_blank" rel="noopener" href="https://github.com/syndtr/goleveldb">https://github.com/syndtr/goleveldb</a> PingCAP的人好爱用levelDB。难道是因为LevelDB 是基于内存 + SSD的冷热分离架构。</p>
<p>你能看到这，说明你还是很有耐心的，TiDB是很有前途的NewSQL数据库，真心希望他们走的越来越好。早早兼容Oracle语法。当好去IOE排头兵。</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><a class="button is-default" href="/2020/02/29/%E6%95%B0%E6%8D%AE%E5%BA%93/2020-02-29-Business%20Analytics%20Study/" title="数据分析团队培养是数字化转型关键一环"><i class="iconfont icon-prev mr-2 has-text-grey"></i><span class="has-text-weight-semibold">上一页: 数据分析团队培养是数字化转型关键一环</span></a><a class="button is-default" href="/2020/02/17/%E5%A4%A7%E6%95%B0%E6%8D%AE/2020-02-17-the%20art%20of%20data%20in%20mfg/" title="并非那么枯燥，手机生产的数字缠绕实现艺术感十足"><span class="has-text-weight-semibold">下一页: 并非那么枯燥，手机生产的数字缠绕实现艺术感十足</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="zhengr/robin-zheng-blog" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><a title="twitter" target="_blank" rel="noopener nofollow" href="//twitter.com//"><i class="iconfont icon-twitter"></i></a><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/zhengr"><i class="iconfont icon-github"></i></a><!-- Ins--><a title="instagram" target="_blank" rel="noopener nofollow" href="//www.instagram.com//"><i class="iconfont icon-ins"></i></a><!-- RSS--><a title="rss" target="_blank" rel="noopener nofollow" href="/atom.xml"><i class="iconfont icon-rss"></i></a><!-- 知乎--><!-- 领英--><!-- 脸书--><a title="facebook" target="_blank" rel="noopener nofollow" href="//www.facebook.com//"><i class="iconfont icon-tian7_facebook"></i></a></section><p><span>Copyright ©</span><span> Robin 2023</span></p></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>